#pragma once


// CTPArticleListCtrl
#define M2 40
enum TP_CLIPICON_INDEX
{
	TP_CLIPICON_N1,
	TP_CLIPICON_S1,
	TP_CLIPICON_C1,
	TP_CLIPICON_D1,
	TP_CLIPICON_N2,
	TP_CLIPICON_S2,
	TP_CLIPICON_C2,
	TP_CLIPICON_D2,
	TP_CLIPICON_N3,
	TP_CLIPICON_S3,
	TP_CLIPICON_C3,
	TP_CLIPICON_D3,
	TP_CLIPICON_N4,
	TP_CLIPICON_S4,
	TP_CLIPICON_C4,
	TP_CLIPICON_D4,

	TP_CLIPICON1_N1,
	TP_CLIPICON1_S1,
	TP_CLIPICON1_C1,
	TP_CLIPICON1_D1,
	TP_CLIPICON1_N2,
	TP_CLIPICON1_S2,
	TP_CLIPICON1_C2,
	TP_CLIPICON1_D2,
	TP_CLIPICON1_N3,
	TP_CLIPICON1_S3,
	TP_CLIPICON1_C3,
	TP_CLIPICON1_D3,
	TP_CLIPICON1_N4,
	TP_CLIPICON1_S4,
	TP_CLIPICON1_C4,
	TP_CLIPICON1_D4,


	TP_CLIPICON2_N1,
	TP_CLIPICON2_S1,
	TP_CLIPICON2_C1,
	TP_CLIPICON2_D1,
	TP_CLIPICON2_N2,
	TP_CLIPICON2_S2,
	TP_CLIPICON2_C2,
	TP_CLIPICON2_D2,
	TP_CLIPICON2_N3,
	TP_CLIPICON2_S3,
	TP_CLIPICON2_C3,
	TP_CLIPICON2_D3,
	TP_CLIPICON2_N4,
	TP_CLIPICON2_S4,
	TP_CLIPICON2_C4,
	TP_CLIPICON2_D4,

	TP_CLIPICON3_N1,
	TP_CLIPICON3_S1,
	TP_CLIPICON3_C1,
	TP_CLIPICON3_D1,
	TP_CLIPICON3_N2,
	TP_CLIPICON3_S2,
	TP_CLIPICON3_C2,
	TP_CLIPICON3_D2,
	TP_CLIPICON3_N3,
	TP_CLIPICON3_S3,
	TP_CLIPICON3_C3,
	TP_CLIPICON3_D3,
	TP_CLIPICON3_N4,
	TP_CLIPICON3_S4,
	TP_CLIPICON3_C4,
	TP_CLIPICON3_D4,

	TP_CLIPICON4_N1,
	TP_CLIPICON4_S1,
	TP_CLIPICON4_C1,
	TP_CLIPICON4_D1,
	TP_CLIPICON4_N2,
	TP_CLIPICON4_S2,
	TP_CLIPICON4_C2,
	TP_CLIPICON4_D2,
	TP_CLIPICON4_N3,
	TP_CLIPICON4_S3,
	TP_CLIPICON4_C3,
	TP_CLIPICON4_D3,
	TP_CLIPICON4_N4,
	TP_CLIPICON4_S4,
	TP_CLIPICON4_C4,
	TP_CLIPICON4_D4,

	TP_CLIPICON5_N1,
	TP_CLIPICON5_S1,
	TP_CLIPICON5_C1,
	TP_CLIPICON5_D1,
	TP_CLIPICON5_N2,
	TP_CLIPICON5_S2,
	TP_CLIPICON5_C2,
	TP_CLIPICON5_D2,
	TP_CLIPICON5_N3,
	TP_CLIPICON5_S3,
	TP_CLIPICON5_C3,
	TP_CLIPICON5_D3,
	TP_CLIPICON5_N4,
	TP_CLIPICON5_S4,
	TP_CLIPICON5_C4,
	TP_CLIPICON5_D4,

	TP_CLIPICON6_N1,
	TP_CLIPICON6_S1,
	TP_CLIPICON6_C1,
	TP_CLIPICON6_D1,
	TP_CLIPICON6_N2,
	TP_CLIPICON6_S2,
	TP_CLIPICON6_C2,
	TP_CLIPICON6_D2,
	TP_CLIPICON6_N3,
	TP_CLIPICON6_S3,
	TP_CLIPICON6_C3,
	TP_CLIPICON6_D3,
	TP_CLIPICON6_N4,
	TP_CLIPICON6_S4,
	TP_CLIPICON6_C4,
	TP_CLIPICON6_D4,

	TP_CLIPICON7_N1,
	TP_CLIPICON7_S1,
	TP_CLIPICON7_C1,
	TP_CLIPICON7_D1,
	TP_CLIPICON7_N2,
	TP_CLIPICON7_S2,
	TP_CLIPICON7_C2,
	TP_CLIPICON7_D2,
	TP_CLIPICON7_N3,
	TP_CLIPICON7_S3,
	TP_CLIPICON7_C3,
	TP_CLIPICON7_D3,
	TP_CLIPICON7_N4,
	TP_CLIPICON7_S4,
	TP_CLIPICON7_C4,
	TP_CLIPICON7_D4,

	TP_CLIPICON8_N1,
	TP_CLIPICON8_S1,
	TP_CLIPICON8_C1,
	TP_CLIPICON8_D1,
	TP_CLIPICON8_N2,
	TP_CLIPICON8_S2,
	TP_CLIPICON8_C2,
	TP_CLIPICON8_D2,
	TP_CLIPICON8_N3,
	TP_CLIPICON8_S3,
	TP_CLIPICON8_C3,
	TP_CLIPICON8_D3,
	TP_CLIPICON8_N4,
	TP_CLIPICON8_S4,
	TP_CLIPICON8_C4,
	TP_CLIPICON8_D4,

	TP_CLIPICON9_N1,
	TP_CLIPICON9_S1,
	TP_CLIPICON9_C1,
	TP_CLIPICON9_D1,
	TP_CLIPICON9_N2,
	TP_CLIPICON9_S2,
	TP_CLIPICON9_C2,
	TP_CLIPICON9_D2,
	TP_CLIPICON9_N3,
	TP_CLIPICON9_S3,
	TP_CLIPICON9_C3,
	TP_CLIPICON9_D3,
	TP_CLIPICON9_N4,
	TP_CLIPICON9_S4,
	TP_CLIPICON9_C4,
	TP_CLIPICON9_D4,

	TP_CLIPICON10_N1,
	TP_CLIPICON10_S1,
	TP_CLIPICON10_C1,
	TP_CLIPICON10_D1,
	TP_CLIPICON10_N2,
	TP_CLIPICON10_S2,
	TP_CLIPICON10_C2,
	TP_CLIPICON10_D2,
	TP_CLIPICON10_N3,
	TP_CLIPICON10_S3,
	TP_CLIPICON10_C3,
	TP_CLIPICON10_D3,
	TP_CLIPICON10_N4,
	TP_CLIPICON10_S4,
	TP_CLIPICON10_C4,
	TP_CLIPICON10_D4,

	TP_CLIPICON11_N1,
	TP_CLIPICON11_S1,
	TP_CLIPICON11_C1,
	TP_CLIPICON11_D1,
	TP_CLIPICON11_N2,
	TP_CLIPICON11_S2,
	TP_CLIPICON11_C2,
	TP_CLIPICON11_D2,
	TP_CLIPICON11_N3,
	TP_CLIPICON11_S3,
	TP_CLIPICON11_C3,
	TP_CLIPICON11_D3,
	TP_CLIPICON11_N4,
	TP_CLIPICON11_S4,
	TP_CLIPICON11_C4,
	TP_CLIPICON11_D4,


	TP_CLIPICON_STATUSINDICATORS,
	TP_CLIPICON_TYPEINDICATORS,
	TP_CLIPICON_STATUSTEAM,
	TP_CLIPICON_OKNG,
	TP_CLIPICON_FLODER,
	TP_CLIPICON_OFFLINE,
	TP_CLIPICON_AUDIO,
	TP_CLIPICON_TYPEINDICATORSLARGE,
	TP_CLIPICON_OFFLINELARGE,
	TP_CLIPICON_DELPROTECT,
	TP_CLIPICON_ICONOVERLAY,
	TP_CLIPICON_MAX,
};
enum TP_RESTEXT_INDEX
{
	TP_RESTEXT_NAME = 0,
	TP_RESTEXT_STATE,	

};
typedef  struct tag_TPListItemData
{

	HRESDATA       hResData;			//  材句柄
	TP_RES_TYPE    eResType;            //  素材类型
	GUID           guidRes;				//  素材ID
	GUID           guidDBType;			//  数据库ID
	GUID           guidNode;            //  所在目录ID
	GUID           guidRecyleNode;      //  所在目录ID
//	TP_NODE_TYPE   eNodeType;			//  目录类型
	TP_CHANNEL_NODETYPE		eNodeType;
	DWORD          dwOperateFlag;       //  操作类型
	LPARAM         lParam;
	DWORD          dwState;
	//显示数据
	UINT           uResSource;			//  来源附加标志 U1
	DWORD          dwUseState;			//  使用状态标志
	int            iNPIndex;			//  图标索引
	long           lRefCount;			//  引用计数
	CString        VAString;	
	CString        sText[M2];			//  附加信息
	DWORD          dwBookIndex; 

	// 图标信息
	BOOL           bIs0403Icon;         //  是否为4：3的格式
	BOOL           bDelIcon;			
	LPBYTE         pIcon;				//  小图标
	CSize          szIcon;
	BOOL           bGetData;			// 
	BYTE           bGetIndex; 
	BOOL           bGetFile;	
	DWORD          dwCaptureFlag;
	LPBYTE         pBuffer;             //  大图标数据
	CSize          szBuffer;
	CString        sFileName;			//  图标文件名
	CString        sKeyFileName;		//  KYE文件名
	INT64          iFrame;				//  图标位置			
	BOOL           bGetBuffer;			

	BOOL				bDropFrame;		//  丢帧标志
	COLORREF            cResColor;
	TP_VIDEO_STANDARD   eVideoStand; 
	INT64               uResFlag;	
	INT64				lLength;
	INT64               lListItemFlag;
	SYSTEMTIME			tmCreateTime;	//  创建时间
	SYSTEMTIME          tmModifyTime;   //  修改时间
	SYSTEMTIME			tmRecTime;		//  拍摄时间
	long                lListIndex[2];
	CRect               rtIcon;

	TPListCtrlItem *pItem;
	tag_TPListItemData()
	{
		hResData				= NULL;
		eResType				= TP_RES_UNKNOW;
		guidRes					= GUID_NULL;		
		guidDBType				= GUID_NULL;
		guidNode				= GUID_NULL;
		guidRecyleNode			= GUID_NULL;
// 		eNodeType				= 0;
		eNodeType				= TP_CHANNEL_UNKNOW;
		dwOperateFlag			= 0;
		lParam					= NULL;
		dwState					= 0;

// 		lListItemFlag			= TP_ITEMFLAG_UNKNOW;
		uResSource				= 0;
		dwUseState				= 0;
		iNPIndex				= 0;
		lRefCount				= -1; 
		bDelIcon				= FALSE; 
		pIcon					 = NULL; 
		szIcon					= CSize(0,0);
		VAString				= _L("");	
		dwBookIndex				= 0; 
		bGetData				= FALSE;
		bGetIndex               = FALSE;  
		bGetFile                = FALSE;
		bIs0403Icon				= TRUE;
		pBuffer					= NULL; 
		szBuffer				= CSize(0,0);
		sFileName				= _L("");
		sKeyFileName			= _L("");
		iFrame					= 0;
		lLength                 = 0;
		bGetBuffer				= FALSE;
		pItem					= NULL;
		bDropFrame              = FALSE;
		cResColor               = 0;
		eVideoStand				= TP_VIDEOSTANDARD_UNKNOW;
		uResFlag				= 0;
		ZeroMemory(&tmCreateTime, sizeof(tmCreateTime));
		ZeroMemory(&tmModifyTime, sizeof(tmModifyTime));
		ZeroMemory(&tmRecTime, sizeof(tmRecTime));
		lListIndex[0]          = -1;
		lListIndex[1]          = -1;
		rtIcon                 = CRect(0,0,0,0);

	}
	void SetResBaseData(TPResData &hSetResData)
	{
		hResData      = hSetResData.hResData;
		eResType      = hSetResData.eResType;
		guidRes       = hSetResData.guidRes;
		guidDBType    = hSetResData.guidDBType;		
		guidNode      = hSetResData.guidNode;
		eNodeType     = hSetResData.eNodeType;
		dwOperateFlag = hSetResData.dwOperateFlag;
		lParam        = hSetResData.lParam;		
	}
	void GetResBaseData(TPResData &hGetResData)
	{
		hGetResData.hResData       = hResData;
		hGetResData.eResType       = eResType;
		hGetResData.guidRes        = guidRes;
		hGetResData.guidDBType     = guidDBType;		
		hGetResData.guidNode       = guidNode;
		hGetResData.dwOperateFlag  = dwOperateFlag;
		hGetResData.eNodeType      = eNodeType;
		hGetResData.lParam         = lParam;
	}
	void ReleaseIconBuf()
	{
		if(bDelIcon && pIcon)
		{
			delete []pIcon;
			bDelIcon = FALSE;
		}
		pIcon  = NULL;
		szIcon = CSize(0, 0);
	}

	LPBYTE ResizeBuffer(CSize &szSizeNew)
	{
		if(pBuffer && szBuffer.cx * szBuffer.cy < szSizeNew.cx * szSizeNew.cy)
		{
			delete pBuffer;
			pBuffer = NULL;
			szBuffer = CSize(0, 0);
		}

		if(NULL == pBuffer)
		{
			szBuffer = szSizeNew;
			pBuffer  = new BYTE[szBuffer.cy * szBuffer.cx * 4];
		}
		return pBuffer;
	}
	~tag_TPListItemData()
	{
		bGetBuffer = FALSE;
		if(bDelIcon &&pIcon && pIcon != pBuffer) delete pIcon;		
		if(pBuffer)
		{
			delete pBuffer;
			pBuffer = NULL;
		}
		szBuffer = CSize(0,0);
		pIcon    = NULL;
	}

}TPListItemData;
typedef CArray<TPListItemData *,TPListItemData *&> TPListItemDataArray;
enum TP_LISTVIEW_TYPE
{
	TP_LISTVIEW_UNKNOW,
	TP_LISTVIEW_PUBLICCHANNEL,
	TP_LISTVIEW_PRIVATECHANNEL,
	TP_LISTVIEW_PRIVATEARTILCE,
};
class CTPArticleMainDlg;
class CTPArticleListCtrl : public CTPListCtrlEx
{
	DECLARE_DYNAMIC(CTPArticleListCtrl)

public:
	CTPArticleListCtrl();
	virtual ~CTPArticleListCtrl();

	CTPArticleMainDlg *m_pArticleMainDlg;
public:
	BOOL    SetResData(TPResDataArray &aResData);
	BOOL	UpdateCurArticle(GUID guidRes);
	void	SetViewType(TP_RES_TYPE eResType);
	void	SetChannelChildData(GUID guidChannel);
	BOOL    GetArticleData(GUID guidArticle);
	BOOL    GetArticleByThread(TPResDataArray	&aNeedGetData);
	void    GotoArticle(BOOL bForward = TRUE);


private:
	//update
	CWinThread		*m_pRunThread; 
	BOOL			m_bOpenThread;
	HANDLE			m_hOpenThread;  
	int				m_nUpdateCount;
	int				m_nUpdateCountAll;
	TPResDataArray	m_aNeedGetData;
	CRITICAL_SECTION m_csTeamCmd;      //公共数据锁
	//

	static	UINT TP_GetArticleItemThread(LPVOID pVoid);
	LRESULT          OnMsgRefreshItem(WPARAM wp,LPARAM lp);
public:
	afx_msg void OnLvnItemchanged(NMHDR *pNMHDR, LRESULT *pResult);
	afx_msg void OnLvnDeleteitem(NMHDR *pNMHDR, LRESULT *pResult);
	afx_msg void OnLButtonDblClk(UINT nFlags, CPoint point);
	afx_msg void OnLButtonDown(UINT nFlags, CPoint point);

private:
	TP_LISTVIEW_TYPE m_eListViewType;
	void  GetItemResData(TPListItemData *pItemData,BOOL bGetData = TRUE);
	void  UpdateLoadStatus(BOOL bPlus = TRUE, BOOL bReset = FALSE);
	virtual void    DrawTextPicture(CDC *pDC,int iItem);
	virtual void	DrawReport(CDC *pDC,int iItem);
	virtual void    DrawIcon(CDC *pDC,int iItem);
	virtual void    PaintHead(CDC *pDC);
protected:
	DECLARE_MESSAGE_MAP()
public:
	afx_msg int OnCreate(LPCREATESTRUCT lpCreateStruct);
};


